<main>
  <section id="perfil" class="flex h-auto flex-col items-center justify-center bg-customPurple bg-[url('/assets/img/huellas.png')] bg-cover bg-center px-6 py-24 md:flex-row">
    <div class="w-full max-w-6xl bg-white rounded-lg shadow-lg mx-4">
      <div class="flex flex-wrap gap-6 px-8 pt-8 rounded-lg border-customBlue bg-gray-200">
        <button (click)="seleccionarPestana('datosPersonales')"
                class="font-bold text-customBlue text-lg md:text-xl pb-3 transition border-b-4"
                [class.border-customBlue]="pestanaSeleccionada === 'datosPersonales'">
          Datos personales
        </button>
        <button (click)="seleccionarPestana('solicitudes')"
                class="font-bold text-lg md:text-xl pb-3 transition border-b-4"
                [class.border-customBlue]="pestanaSeleccionada === 'solicitudes'">
          Solicitudes
        </button>
        <button *ngIf="rol === 'Protectora'" (click)="seleccionarPestana('animales')"
                class="font-bold text-lg md:text-xl pb-3 transition border-b-4"
                [class.border-customBlue]="pestanaSeleccionada === 'animales'">
          Animales
        </button>
      </div>

      <div class="p-8 min-h-[500px] flex flex-col justify-start">

        <!-- PESTAÑA DATOS PERSONALES -->
        <ng-container *ngIf="pestanaSeleccionada === 'datosPersonales'">
          <form [formGroup]="form" (ngSubmit)="actualizarDatos()" class="grid grid-cols-1 gap-6">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" *ngIf="rol === 'Adoptante'">
              <div>
                <label for="nombre" class="text-xl block mb-2">Nombre:</label>
                <input id="nombre" type="text" formControlName="nombre" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                       [class.border-red-500]="campoInvalido('nombre')" />
                <small *ngIf="campoInvalido('nombre')" class="text-red-500">Nombre requerido</small>
              </div>
              <div>
                <label for="apellidos" class="text-xl block mb-2">Apellidos:</label>
                <input id="apellidos" type="text" formControlName="apellidos" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                       [class.border-red-500]="campoInvalido('apellidos')" />
                <small *ngIf="campoInvalido('apellidos')" class="text-red-500">Apellidos requeridos</small>
              </div>
            </div>

            <div *ngIf="rol === 'Protectora'">
              <label for="nombre" class="text-xl block mb-2">Nombre de la protectora:</label>
              <input id="nombre" type="text" formControlName="nombre" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                     [class.border-red-500]="campoInvalido('nombre')" />
              <small *ngIf="campoInvalido('nombre')" class="text-red-500">Nombre requerido</small>
            </div>

            <div>
              <label for="direccion" class="text-xl block mb-2">Dirección:</label>
              <input id="direccion" type="text" formControlName="direccion" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                     [class.border-red-500]="campoInvalido('direccion')" />
              <small *ngIf="campoInvalido('direccion')" class="text-red-500">Dirección requerida</small>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" *ngIf="rol === 'Adoptante'">
              <div>
                <label for="codigoPostal" class="text-xl block mb-2">Código Postal:</label>
                <input id="codigoPostal" type="text" formControlName="codigoPostal" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                       [class.border-red-500]="campoInvalido('codigoPostal')" />
                <small *ngIf="campoInvalido('codigoPostal')" class="text-red-500">Formato inválido</small>
              </div>
              <div>
                <label for="poblacion" class="text-xl block mb-2">Población:</label>
                <input id="poblacion" type="text" formControlName="poblacion" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                       [class.border-red-500]="campoInvalido('poblacion')" />
                <small *ngIf="campoInvalido('poblacion')" class="text-red-500">Población requerida</small>
              </div>
            </div>

            <div>
              <label for="provincia" class="text-xl block mb-2">Provincia:</label>
              <input id="provincia" type="text" formControlName="provincia" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                     [class.border-red-500]="campoInvalido('provincia')" />
              <small *ngIf="campoInvalido('provincia')" class="text-red-500">Provincia requerida</small>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="telefono" class="text-xl block mb-2">Teléfono:</label>
                <input id="telefono" type="text" formControlName="telefono" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                       [class.border-red-500]="campoInvalido('telefono')" />
                <small *ngIf="campoInvalido('telefono')" class="text-red-500">Teléfono inválido</small>
              </div>
              <div>
                <label for="email" class="text-xl block mb-2">Correo electrónico:</label>
                <input id="email" type="email" formControlName="email" class="w-full bg-gray-200 rounded-lg border-2 px-4 py-2"
                       [class.border-red-500]="campoInvalido('email')" />
                <small *ngIf="campoInvalido('email')" class="text-red-500">Email inválido</small>
              </div>
            </div>

            <div class="w-full flex justify-center pt-4 border-t border-gray-100">
              <app-boton-principal [tipo]="'submit'"
                                   [texto]="guardando ? 'Guardando...' : 'Actualizar'"
                                   [disabled]="guardando || form.invalid"
                                   class="w-full sm:w-auto mt-6">
              </app-boton-principal>
            </div>
          </form>
        </ng-container>

        <!-- PESTAÑA SOLICITUDES -->
        <ng-container *ngIf="pestanaSeleccionada === 'solicitudes'">
          <!-- solicitudes adoptante -->
          <div *ngIf="rol === 'Adoptante'" class="flex flex-col mb-8">
            <h3 class="text-2xl font-semibold mb-4">Mis solicitudes de adopción</h3>
            <div *ngIf="solicitudesCargando" class="text-gray-600">Cargando solicitudes...</div>
            <div *ngIf="solicitudesError" class="text-red-600">{{ solicitudesError }}</div>
            <div *ngIf="!solicitudesCargando && solicitudes.length === 0 && !solicitudesError" class="text-gray-600">No tienes solicitudes todavía.</div>
            <ul *ngIf="!solicitudesCargando && solicitudes.length > 0" class="space-y-3">
              <li *ngFor="let s of solicitudes" class="p-4 border rounded-lg shadow-sm bg-gray-50 flex flex-col gap-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold truncate">{{ s.animal?.nombre || 'Animal' }}</p>
                    <p class="text-sm text-gray-600">
                      Estado: <span [ngClass]="{
                        'text-yellow-600': s.estado === 'pendiente',
                        'text-green-600': s.estado === 'aceptada',
                        'text-red-600': s.estado === 'rechazada',
                        'text-gray-600': s.estado === 'actualizando'
                      }">{{ s.estado }}</span>
                    </p>
                    <p class="text-sm mt-1" *ngIf="s.comentario">Comentario: {{ s.comentario }}</p>
                    <p class="text-xs text-gray-400 mt-1">Fecha: {{ s.createdAt | date:'short' }}</p>
                  </div>
                  <div class="flex-shrink-0 flex justify-center md:justify-end">
                    <img *ngIf="s.animal?.imagenPrincipal" [src]="s.animal?.imagenPrincipal" alt="{{ s.animal?.nombre }}" class="w-24 h-24 object-cover rounded-md border" />
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <!-- solicitudes protectora -->
          <div *ngIf="rol === 'Protectora'" class="flex flex-col">
            <h3 class="text-2xl font-semibold mb-4">Solicitudes recibidas</h3>
            <div *ngIf="solicitudesCargando" class="text-gray-600">Cargando solicitudes...</div>
            <div *ngIf="solicitudesError" class="text-red-600">{{ solicitudesError }}</div>
            <div *ngIf="!solicitudesCargando && solicitudes.length === 0 && !solicitudesError" class="text-gray-600">No hay solicitudes recibidas.</div>
            <ul *ngIf="!solicitudesCargando && solicitudes.length > 0" class="space-y-3">
              <li *ngFor="let s of solicitudes" class="p-4 border rounded-lg shadow-sm bg-gray-50 flex flex-col gap-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold truncate">{{ s.animal?.nombre || 'Animal' }}</p>
                    <p class="text-sm text-gray-600">
                      Estado: <span [ngClass]="{
                        'text-yellow-600': s.estado === 'pendiente',
                        'text-green-600': s.estado === 'aceptada',
                        'text-red-600': s.estado === 'rechazada',
                        'text-gray-600': s.estado === 'actualizando'
                      }">{{ s.estado }}</span>
                    </p>
                    <p class="text-sm mt-1" *ngIf="s.comentario">Comentario: {{ s.comentario }}</p>
                    <p class="text-xs text-gray-400 mt-1">Fecha: {{ s.createdAt | date:'short' }}</p>
                    <div class="mt-2 text-sm text-gray-700" *ngIf="s.adoptanteEmail">
                      <p><span class="font-semibold">Adoptante:</span> {{ s.adoptanteNombre }} {{ s.adoptanteApellidos }}</p>
                      <p><span class="font-semibold">Email:</span> {{ s.adoptanteEmail }}</p>
                      <p *ngIf="s.adoptanteTelefono"><span class="font-semibold">Teléfono:</span> {{ s.adoptanteTelefono }}</p>
                    </div>
                  </div>
                  <div class="flex-shrink-0 flex justify-center md:justify-end">
                    <img *ngIf="s.animal?.imagenPrincipal" [src]="s.animal?.imagenPrincipal" alt="{{ s.animal?.nombre }}" class="w-24 h-24 object-cover rounded-md border" />
                  </div>
                </div>
                <div class="flex gap-3 md:justify-end" *ngIf="s.estado === 'pendiente'">
                  <button type="button" (click)="aceptarSolicitud(s.id)" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm">Aceptar</button>
                  <button type="button" (click)="rechazarSolicitud(s.id)" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm">Rechazar</button>
                </div>
                <div class="text-sm text-gray-500" *ngIf="s.estado === 'actualizando'">Actualizando...</div>
              </li>
            </ul>
          </div>
        </ng-container>

        <!-- animales protectora  -->
        <ng-container *ngIf="pestanaSeleccionada === 'animales' && rol === 'Protectora'">
          <h3 class="text-2xl font-semibold mb-4">Mis animales en adopción</h3>
          <div *ngIf="animalesCargando" class="text-gray-600">Cargando animales...</div>
          <div *ngIf="animalesError" class="text-red-600">{{ animalesError }}</div>
          <div *ngIf="!animalesCargando && animales.length === 0 && !animalesError" class="text-gray-600">No tienes animales publicados.</div>
          <ul *ngIf="!animalesCargando && animales.length > 0" class="space-y-3">
            <li *ngFor="let a of animales" class="p-4 border rounded-lg shadow-sm bg-gray-50 flex flex-col gap-4">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <p class="font-semibold truncate">{{ a.nombre }}</p>
                  <p class="text-sm text-gray-600">Tipo: {{ a.tipo }} | Edad: {{ a.edad || 'N/D' }}</p>
                  <p class="text-sm text-gray-600" *ngIf="a.raza">Raza: {{ a.raza }}</p>
                  <p class="text-sm text-gray-600" *ngIf="a.genero">Género: {{ a.genero }}</p>
                  <p class="text-xs text-gray-400 mt-1">Publicación: {{ a.createdAt | date:'short' }}</p>
                  <p class="text-sm mt-2" *ngIf="a.descripcion"><span class="font-semibold">Descripción:</span> {{ a.descripcion }}</p>
                  <div class="mt-3 flex gap-3">
                    <button type="button"
                            (click)="eliminarAnimal(a.uuid)"
                            [disabled]="eliminandoAnimalUuid === a.uuid"
                            class="px-4 py-2 rounded text-sm"
                            [ngClass]="eliminandoAnimalUuid === a.uuid ? 'bg-red-300 text-red-700 cursor-wait' : 'bg-red-600 hover:bg-red-700 text-white'">
                      {{ eliminandoAnimalUuid === a.uuid ? 'Eliminando...' : 'Eliminar' }}
                    </button>
                  </div>
                </div>
                <div class="flex-shrink-0 flex justify-center md:justify-end">
                  <img *ngIf="a.imagenPrincipal" [src]="a.imagenPrincipal" [alt]="a.nombre" class="w-24 h-24 object-cover rounded-md border" />
                </div>
              </div>
            </li>
          </ul>
        </ng-container>

        <div *ngIf="cargando" class="text-center mt-6">Cargando...</div>
        <div *ngIf="error" class="text-center mt-6 text-red-600">{{ error }}</div>
      </div>
    </div>
  </section>
</main>
